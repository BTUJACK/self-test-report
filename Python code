import re
import tkinter as tk
from tkinter import filedialog, messagebox
from docx import Document
from docx.enum.text import WD_PARAGRAPH_ALIGNMENT
from docx.oxml import OxmlElement
from docx.oxml.ns import qn
from docx.shared import Pt
import sys

# ä¸¥æ ¼æ ¡éªŒPython 3.8.7ç‰ˆæœ¬
assert sys.version_info >= (3, 8) and sys.version_info < (3, 9), \
    f"å½“å‰Pythonç‰ˆæœ¬ï¼š{sys.version}ï¼Œè¯·ä½¿ç”¨3.8.7ç‰ˆæœ¬ï¼"

def extract_title_number(cell_text):
    """
    æå–å¹¶å‰ªåˆ‡æ ‡é¢˜å·ç ï¼šæ•°å­—+ç‚¹ç»„åˆï¼ˆä»ç¬¬äºŒåˆ—é¦–ä¸ªæ•°å­—åˆ°ç¬¬ä¸€ä¸ªæ±‰å­—ç»“æŸï¼‰
    è¿”å›ï¼š(æ ‡é¢˜å·ç , å‰ªåˆ‡åçš„å‰©ä½™æ–‡æœ¬)
    """
    if not cell_text:
        return "", cell_text
    
    # æ­£åˆ™ç²¾å‡†åŒ¹é…æ•°å­—+ç‚¹çš„ç»„åˆï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªæ±‰å­—
    pattern = re.compile(r'^([0-9\.]+)[^\u4e00-\u9fa5]*')
    match = pattern.search(cell_text)
    
    if match:
        title_num = match.group(1)
        # å‰ªåˆ‡ï¼šåˆ é™¤åŸæ–‡æœ¬ä¸­çš„æ ‡é¢˜å·ç éƒ¨åˆ†
        remaining_text = cell_text[len(match.group(0)):].strip()
        return title_num, remaining_text
    return "", cell_text

def get_original_border_attrs(cell):
    """è·å–å•å…ƒæ ¼åŸæœ‰è¾¹æ¡†çš„å®Œæ•´æ ¼å¼ï¼ˆç²—ç»†ã€é¢œè‰²ã€ç±»å‹ï¼‰"""
    tc_borders = cell._tc.get_or_add_tcPr().find(qn('w:tcBorders'))
    # é»˜è®¤æ ¼å¼ï¼ˆåŒ¹é…Wordé»˜è®¤è¡¨æ ¼æ ·å¼ï¼‰
    default_attrs = {
        'sz': '4',       # è¾¹æ¡†ç²—ç»†ï¼ˆ1/8ç£…å•ä½ï¼Œ4=0.5ç£…ï¼‰
        'color': 'auto', # è¾¹æ¡†é¢œè‰²
        'val': 'single'  # è¾¹æ¡†ç±»å‹ï¼ˆå®çº¿ï¼‰
    }
    
    if tc_borders is None:
        return default_attrs
    
    # ä¼˜å…ˆè¯»å–topè¾¹æ¡†ï¼ˆæœ€å…·ä»£è¡¨æ€§ï¼‰çš„æ ¼å¼
    top_border = tc_borders.find(qn('w:top'))
    if top_border is not None:
        default_attrs['sz'] = top_border.get(qn('w:sz')) or default_attrs['sz']
        default_attrs['color'] = top_border.get(qn('w:color')) or default_attrs['color']
        default_attrs['val'] = top_border.get(qn('w:val')) or default_attrs['val']
    
    return default_attrs

def adjust_cell_borders(row, start_col, end_col):
    """
    éšè—2-6åˆ—å†…æ¡†ï¼Œä¿ç•™å¤–æ¡†ï¼ˆå®Œå…¨ç»§æ‰¿åŸè¾¹æ¡†æ ¼å¼ï¼Œç¦æ­¢åˆå¹¶å•å…ƒæ ¼ï¼‰
    :param row: ç›®æ ‡è¡Œ
    :param start_col: èµ·å§‹åˆ—ç´¢å¼•ï¼ˆç¬¬äºŒåˆ—=1ï¼‰
    :param end_col: ç»“æŸåˆ—ç´¢å¼•ï¼ˆç¬¬å…­åˆ—=5ï¼‰
    """
    if start_col < 0 or end_col >= len(row.cells):
        return
    
    # è·å–åŸè¡¨æ ¼è¾¹æ¡†æ ¼å¼ï¼ˆä»¥ç¬¬äºŒåˆ—å•å…ƒæ ¼ä¸ºåŸºå‡†ï¼‰
    border_attrs = get_original_border_attrs(row.cells[start_col])
    
    # é€åˆ—è®¾ç½®è¾¹æ¡†ï¼šä¿ç•™å¤–æ¡†ã€éšè—å†…æ¡†
    for col_idx in range(start_col, end_col + 1):
        cell = row.cells[col_idx]
        tc_borders = OxmlElement('w:tcBorders')
        
        # è¾¹æ¡†è§„åˆ™ï¼ˆç²¾å‡†æ§åˆ¶å†…/å¤–æ¡†ï¼‰
        if col_idx == start_col:  # ç¬¬äºŒåˆ—ï¼ˆå·¦å¤–æ¡†ï¼‰
            border_rules = {
                'left': border_attrs['val'],  # ä¿ç•™å·¦å¤–æ¡†
                'top': border_attrs['val'],   # ä¿ç•™ä¸Šæ¡†
                'bottom': border_attrs['val'],# ä¿ç•™ä¸‹æ¡†
                'right': 'nil'                # éšè—å³å†…æ¡†
            }
        elif col_idx == end_col:  # ç¬¬å…­åˆ—ï¼ˆå³å¤–æ¡†ï¼‰
            border_rules = {
                'right': border_attrs['val'], # ä¿ç•™å³å¤–æ¡†
                'top': border_attrs['val'],   # ä¿ç•™ä¸Šæ¡†
                'bottom': border_attrs['val'],# ä¿ç•™ä¸‹æ¡†
                'left': 'nil'                 # éšè—å·¦å†…æ¡†
            }
        else:  # 3-5åˆ—ï¼ˆä¸­é—´åˆ—ï¼‰
            border_rules = {
                'top': border_attrs['val'],   # ä¿ç•™ä¸Šæ¡†
                'bottom': border_attrs['val'],# ä¿ç•™ä¸‹æ¡†
                'left': 'nil',                # éšè—å·¦å†…æ¡†
                'right': 'nil'                # éšè—å³å†…æ¡†
            }
        
        # åº”ç”¨è¾¹æ¡†æ ¼å¼ï¼ˆå®Œå…¨ç»§æ‰¿åŸæœ‰æ ·å¼ï¼‰
        for border_name, border_val in border_rules.items():
            b = OxmlElement(f'w:{border_name}')
            b.set(qn('w:val'), border_val)
            b.set(qn('w:sz'), border_attrs['sz'])       # ä¿ç•™åŸç²—ç»†
            b.set(qn('w:color'), border_attrs['color']) # ä¿ç•™åŸé¢œè‰²
            b.set(qn('w:space'), '0')
            tc_borders.append(b)
        
        # æ›¿æ¢å•å…ƒæ ¼è¾¹æ¡†é…ç½®ï¼ˆè¦†ç›–ä½†ä¿ç•™åŸæ ¼å¼ï¼‰
        cell._tc.get_or_add_tcPr().append(tc_borders)

def merge_content_visually(row, start_col, end_col):
    """
    è§†è§‰ä¸Šåˆå¹¶2-6åˆ—å†…å®¹ï¼ˆæ–‡æœ¬å±‚é¢ï¼Œéå•å…ƒæ ¼åˆå¹¶ï¼‰ï¼Œé å·¦å¯¹é½
    """
    # æ”¶é›†2-6åˆ—æ‰€æœ‰å†…å®¹
    content_list = []
    for col_idx in range(start_col, end_col + 1):
        content_list.append(row.cells[col_idx].text.strip())
    
    # æ‹¼æ¥å†…å®¹ï¼ˆè¿‡æ»¤ç©ºå€¼ï¼Œä¿ç•™æ¢è¡Œï¼‰
    merged_content = '\n'.join([c for c in content_list if c])
    
    # å†…å®¹æ”¾å…¥ç¬¬äºŒåˆ—ï¼Œæ¸…ç©º3-6åˆ—æ–‡æœ¬
    row.cells[start_col].text = merged_content
    for col_idx in range(start_col + 1, end_col + 1):
        row.cells[col_idx].text = ""
    
    # è®¾ç½®å†…å®¹é å·¦å¯¹é½ï¼Œä¿ç•™åŸå­—ä½“æ ¼å¼
    target_cell = row.cells[start_col]
    for para in target_cell.paragraphs:
        para.alignment = WD_PARAGRAPH_ALIGNMENT.LEFT
        # ä»…åœ¨æ— å­—ä½“æ—¶è®¾ç½®å…œåº•æ ·å¼
        for run in para.runs:
            if not run.font.name:
                run.font.name = 'å¾®è½¯é›…é»‘'
                run._element.rPr.rFonts.set(qn('w:eastAsia'), 'å¾®è½¯é›…é»‘')
                run.font.size = Pt(10)

def check_colon_rule(cell_text):
    """
    æ ¡éªŒç¬¬äºŒåˆ—æ˜¯å¦æ»¡è¶³ï¼šå«å†’å·ï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰ä¸”å†’å·åæ— å…¶ä»–å­—ç¬¦
    è¿”å›ï¼šTrue/False
    """
    if not cell_text:
        return False
    
    # å»é™¤é¦–å°¾ç©ºç™½å­—ç¬¦ï¼Œç»Ÿä¸€å¤„ç†ä¸­æ–‡/è‹±æ–‡å†’å·
    clean_text = cell_text.strip()
    # åŒ¹é…â€œä»»æ„å­—ç¬¦+å†’å·+ç»“å°¾â€ï¼ˆå†’å·åæ— å†…å®¹ï¼‰
    colon_pattern = re.compile(r'.*[ï¼š:]$')
    if not colon_pattern.match(clean_text):
        return False
    
    # æå–å†’å·åçš„å­—ç¬¦ï¼ˆéœ€ä¸ºç©ºï¼‰
    colon_index = clean_text.rfind('ï¼š') if 'ï¼š' in clean_text else clean_text.rfind(':')
    after_colon = clean_text[colon_index+1:].strip()
    return len(after_colon) == 0

def process_word(file_path):
    """æ ¸å¿ƒå¤„ç†é€»è¾‘ï¼šä¸¥æ ¼éµå¾ªæ‰€æœ‰æœ€æ–°ç²¾å‡†è§„åˆ™"""
    try:
        doc = Document(file_path)
        
        # éå†æ–‡æ¡£ä¸­æ‰€æœ‰è¡¨æ ¼
        for table in doc.tables:
            # éå†è¡Œï¼ˆè·³è¿‡ç¬¬ä¸€è¡Œæ¨¡æ¿ï¼‰
            for row_idx, row in enumerate(table.rows):
                if row_idx == 0:  # è·³è¿‡æ¨¡æ¿è¡Œ
                    continue
                
                # ç¡®ä¿è¡Œæœ‰è‡³å°‘6åˆ—
                if len(row.cells) < 6:
                    continue
                
                cell_2 = row.cells[1]  # ç¬¬äºŒåˆ—
                cell_2_text = cell_2.text.strip()
                is_processed = False   # æ ‡è®°æ˜¯å¦æ‰§è¡Œè¾¹æ¡†/å†…å®¹å¤„ç†
                
                # è§„åˆ™1ï¼šç¬¬äºŒåˆ—å«å†’å·ä¸”å†’å·åæ— å…¶ä»–å­—ç¬¦ï¼ˆæ”¯æŒä¸­æ–‡/è‹±æ–‡å†’å·ï¼‰
                rule1 = check_colon_rule(cell_2_text)
                # è§„åˆ™2ï¼šç¬¬äºŒåˆ—é¦–å­—ç¬¦æ˜¯æ•°å­—+å°æ•°ç‚¹
                rule2 = len(cell_2_text) >= 2 and cell_2_text[0].isdigit() and cell_2_text[1] == '.'
                
                # æ»¡è¶³ä»»ä¸€è§„åˆ™åˆ™æ‰§è¡Œå¤„ç†
                if rule1 or rule2:
                    is_processed = True
                    
                    # ä»…è§„åˆ™2è§¦å‘æ—¶æå–æ ‡é¢˜å·ç 
                    if rule2:
                        title_num, remaining_text = extract_title_number(cell_2_text)
                        cell_2.text = remaining_text  # æ›¿æ¢ç¬¬äºŒåˆ—æ–‡æœ¬ä¸ºå‰ªåˆ‡åçš„å†…å®¹
                        row.cells[0].text = title_num  # æ ‡é¢˜å·ç æ”¾å…¥ç¬¬ä¸€åˆ—
                    
                    # è°ƒæ•´2-6åˆ—è¾¹æ¡†ï¼ˆéšè—å†…æ¡†ã€ä¿ç•™åŸæ ¼å¼å¤–æ¡†ï¼‰
                    adjust_cell_borders(row, 1, 5)
                    
                    # è§†è§‰ä¸Šåˆå¹¶å†…å®¹ï¼Œé å·¦å¯¹é½
                    merge_content_visually(row, 1, 5)
                
                # è§„åˆ™3&4ï¼šæœªå¤„ç†çš„è¡Œ
                if not is_processed:
                    if len(row.cells) >= 4:
                        # ç¬¬ä¸‰åˆ—å¡«å…¥"ç¬¦åˆè¦æ±‚"
                        cell_3 = row.cells[2]
                        cell_3.text = "ç¬¦åˆè¦æ±‚"
                        # è®¾ç½®ç¬¬ä¸‰åˆ—å†…å®¹é å·¦å¯¹é½
                        for para in cell_3.paragraphs:
                            para.alignment = WD_PARAGRAPH_ALIGNMENT.LEFT
                            for run in para.runs:
                                if not run.font.name:
                                    run.font.name = 'å¾®è½¯é›…é»‘'
                                    run._element.rPr.rFonts.set(qn('w:eastAsia'), 'å¾®è½¯é›…é»‘')
                                    run.font.size = Pt(10)
                        
                        # ç¬¬å››åˆ—æ‰“å‹¾
                        cell_4 = row.cells[3]
                        cell_4.text = "âœ“"
                        # è®¾ç½®å‹¾å·æ ¼å¼ï¼ˆç¡®ä¿æ˜¾ç¤ºæ­£å¸¸ï¼‰
                        for para in cell_4.paragraphs:
                            para.alignment = WD_PARAGRAPH_ALIGNMENT.LEFT
                            for run in para.runs:
                                if not run.font.name:
                                    run.font.name = 'SimSun'
                                    run._element.rPr.rFonts.set(qn('w:eastAsia'), 'SimSun')
                                    run.font.size = Pt(12)
        
        # ä¿å­˜å¤„ç†åçš„æ–‡æ¡£ï¼ˆä¸è¦†ç›–åŸæ–‡ä»¶ï¼‰
        save_path = file_path.replace('.docx', '_processed.docx')
        doc.save(save_path)
        return save_path
    
    except Exception as e:
        raise Exception(f"æ–‡æ¡£å¤„ç†å‡ºé”™ï¼š{str(e)}")

def select_and_process():
    """GUIå›è°ƒå‡½æ•°ï¼šé€‰æ‹©æ–‡ä»¶å¹¶æ‰§è¡Œå¤„ç†"""
    file_path = filedialog.askopenfilename(
        title="é€‰æ‹©Wordæ–‡æ¡£ï¼ˆä»…æ”¯æŒdocxæ ¼å¼ï¼‰",
        filetypes=[("Wordæ–‡æ¡£", "*.docx"), ("æ‰€æœ‰æ–‡ä»¶", "*.*")]
    )
    if not file_path:
        return
    
    try:
        result_path = process_word(file_path)
        messagebox.showinfo("å¤„ç†æˆåŠŸ", f"æ–‡æ¡£å·²å¤„ç†å®Œæˆï¼\nä¿å­˜è·¯å¾„ï¼š\n{result_path}")
    except Exception as e:
        messagebox.showerror("å¤„ç†å¤±è´¥", f"å‡ºé”™åŸå› ï¼š\n{str(e)}")

def create_gui():
    """åˆ›å»ºå¯è§†åŒ–ç”¨æˆ·ç•Œé¢"""
    root = tk.Tk()
    root.title("Wordè‡ªåŠ¨åŒ–å¤„ç†å·¥å…·ï¼ˆPython 3.8.7ï¼‰")
    root.geometry("800x400")
    root.resizable(False, False)
    
    # æ ‡é¢˜
    title_label = tk.Label(
        root,
        text="Wordæ–‡æ¡£è‡ªåŠ¨åŒ–å¤„ç†å·¥å…·",
        font=("å¾®è½¯é›…é»‘", 18, "bold"),
        fg="#2F5496"
    )
    title_label.pack(pady=15)
    
    # è§„åˆ™è¯´æ˜ï¼ˆæ¸…æ™°å±•ç¤ºç²¾å‡†è§„åˆ™ï¼‰
    rule_text = (
        "ğŸ“‹ æ ¸å¿ƒå¤„ç†è§„åˆ™ï¼š\n"
        "1. è·³è¿‡æ¯é¡µç¬¬ä¸€è¡Œæ¨¡æ¿è¡Œï¼Œä¸åšä»»ä½•ä¿®æ”¹ï¼›\n"
        "2. æ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶çš„è¡Œï¼ˆåˆ¤æ–­èŒƒå›´ï¼šä»…ç¬¬äºŒåˆ—ï¼‰ï¼š\n"
        "   - ç¬¬äºŒåˆ—å«å†’å·ï¼ˆä¸­æ–‡ï¼š/è‹±æ–‡:ï¼‰ä¸”å†’å·åæ— ä»»ä½•å­—ç¬¦ï¼ˆå¦‚ï¼šâ€œæ ‡é¢˜ï¼šâ€ï¼Œéâ€œæ ‡é¢˜ï¼šå†…å®¹â€ï¼‰ï¼›\n"
        "   - ç¬¬äºŒåˆ—é¦–å­—ç¬¦ä¸ºã€Œæ•°å­—+å°æ•°ç‚¹ã€ï¼ˆå¦‚ï¼š1.ã€2.3.ï¼‰ï¼›\n"
        "   â†’ éšè—2-6åˆ—å†…æ¡†ï¼Œä¿ç•™åŸæ ¼å¼å¤–æ¡†ï¼ˆç²—ç»†/é¢œè‰²/ç±»å‹ä¸å˜ï¼‰ï¼›\n"
        "   â†’ è§†è§‰ä¸Šåˆå¹¶2-6åˆ—å†…å®¹ï¼ˆæ–‡æœ¬å±‚é¢ï¼‰ï¼Œå†…å®¹é å·¦å¯¹é½ï¼›\n"
        "   â†’ ç¦æ­¢åˆå¹¶å•å…ƒæ ¼/å¤šè¡Œï¼Œä¿æŒåŸè¡¨æ ¼ç»“æ„ï¼›\n"
        "   â†’ ä»…ã€Œæ•°å­—+å°æ•°ç‚¹ã€è¡Œæå–æ ‡é¢˜å·ç ï¼ˆæ•°å­—+ç‚¹ï¼‰å‰ªåˆ‡åˆ°ç¬¬ä¸€åˆ—ï¼›\n"
        "3. æœªè§¦å‘ä¸Šè¿°æ“ä½œçš„è¡Œï¼š\n"
        "   - ç¬¬ä¸‰åˆ—å¡«å…¥ã€Œç¬¦åˆè¦æ±‚ã€å¹¶é å·¦å¯¹é½ï¼›\n"
        "   - ç¬¬å››åˆ—å¡«å…¥å‹¾å·ï¼ˆâœ“ï¼‰å¹¶é å·¦å¯¹é½ã€‚"
    )
    rule_label = tk.Label(
        root,
        text=rule_text,
        font=("å¾®è½¯é›…é»‘", 9),
        justify=tk.LEFT,
        wraplength=780,
        fg="#333333"
    )
    rule_label.pack(pady=10)
    
    # å¤„ç†æŒ‰é’®ï¼ˆç¾åŒ–æ ·å¼ï¼‰
    process_btn = tk.Button(
        root,
        text="é€‰æ‹©å¹¶å¤„ç†docxæ–‡æ¡£",
        font=("å¾®è½¯é›…é»‘", 12, "bold"),
        bg="#2D8CF0",
        fg="white",
        padx=45,
        pady=12,
        relief=tk.RAISED,
        command=select_and_process
    )
    process_btn.pack(pady=15)
    
    # ç‰ˆæœ¬&æ ¼å¼æç¤º
    version_label = tk.Label(
        root,
        text="é€‚é…Python 3.8.7 | ä»…æ”¯æŒ.docxæ ¼å¼æ–‡æ¡£ | å¤„ç†åä¸è¦†ç›–åŸæ–‡ä»¶ | æ”¯æŒä¸­æ–‡/è‹±æ–‡å†’å·",
        font=("å¾®è½¯é›…é»‘", 8),
        fg="#999999"
    )
    version_label.pack(pady=5)
    
    root.mainloop()

if __name__ == "__main__":
    # å®‰è£…ä¾èµ–ï¼ˆå¿…é¡»æ‰§è¡Œï¼Œé€‚é…Python 3.8.7ï¼‰
    # pip install python-docx==0.8.11
    create_gui()
